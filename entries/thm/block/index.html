<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="keywords" content="Block, Block Writeup, Write-Up, TryHackMe, thm, Aleksander Jóźwik" />
  <title>Block</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #232629;
        color: #7a7c7d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
    div.sourceCode
      { color: #cfcfc2; background-color: #232629; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #cfcfc2; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #3f8058; } /* Annotation */
    code span.at { color: #2980b9; } /* Attribute */
    code span.bn { color: #f67400; } /* BaseN */
    code span.bu { color: #7f8c8d; } /* BuiltIn */
    code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #3daee9; } /* Char */
    code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
    code span.co { color: #7a7c7d; } /* Comment */
    code span.cv { color: #7f8c8d; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #2980b9; } /* DataType */
    code span.dv { color: #f67400; } /* DecVal */
    code span.er { color: #da4453; text-decoration: underline; } /* Error */
    code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
    code span.fl { color: #f67400; } /* Float */
    code span.fu { color: #8e44ad; } /* Function */
    code span.im { color: #27ae60; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
    code span.op { color: #cfcfc2; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #27ae60; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #f44f4f; } /* String */
    code span.va { color: #27aeae; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../css/style.css" />
  <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
  <script src="../../../scripts/menu.js"></script>
  <script src="../../../scripts/terminal.js"></script>
  <script src="../../../scripts/images.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="icon" type="image/svg+xml" href="../../../img/favicon/favicon.svg">
</head>
<body>
<div class="logo">
<a href="http://aleksanderjozwik.com"><img src="../../../img/favicon/favicon-64.png" style="width:64px; display:block;"></a>
</div>

<!-- Navbar -->
<nav class="top-navigation">
  <ul>
    <li>
      <a href="https://aleksanderjozwik.com"><i class="fas fa-home"></i> Home</a>
    </li>

    <li>
      <a href="https://www.github.com/jozwikaleksander"><i class="fa-brands fa-github"></i> Github</a>
    </li>

    <li>
      <a href="../../../index.html"><i class="fas fa-book"></i> Write-Ups</a>
    </li>
  </ul>
</nav>
<header id="title-block-header">
<h1 class="title">Block</h1>
<p class="date"><i class="fa-solid fa-calendar"></i> Creation date:<span style='opacity:0;'>_</span>13.08.2024</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#investigating-the-pcap-file"><span class="toc-section-number">1</span> Investigating the PCAP file</a>
<ul>
<li><a href="#what-is-ntproofstr"><span class="toc-section-number">1.1</span> What is Ntproofstr?</a></li>
<li><a href="#how-to-find-ntproofstr"><span class="toc-section-number">1.2</span> How to find Ntproofstr?</a></li>
<li><a href="#finding-encrypted-session-key"><span class="toc-section-number">1.3</span> Finding encrypted session key</a></li>
<li><a href="#finding-the-session-id"><span class="toc-section-number">1.4</span> Finding the session id</a></li>
<li><a href="#script-explanation"><span class="toc-section-number">1.5</span> Script Explanation</a>
<ul>
<li><a href="#transforming-username-and-domain-to-uppercase-next-converting-it-to-bytes."><span class="toc-section-number">1.5.1</span> Transforming username and domain to uppercase, next converting it to bytes.</a></li>
<li><a href="#generating-ntlm-hash-using-md4-hash-function-if-needed"><span class="toc-section-number">1.5.2</span> Generating NTLM hash using MD4 hash function if needed</a></li>
<li><a href="#next-we-are-calculating-response-nt-key"><span class="toc-section-number">1.5.3</span> Next we are calculating Response NT Key</a></li>
<li><a href="#generating-keyexchangekey"><span class="toc-section-number">1.5.4</span> Generating KeyExchangeKey</a></li>
<li><a href="#decrypting-session-key"><span class="toc-section-number">1.5.5</span> Decrypting session key</a></li>
</ul></li>
</ul></li>
<li><a href="#reading-the-dmp-file"><span class="toc-section-number">2</span> Reading the DMP file</a>
<ul>
<li><a href="#pypykatz-output"><span class="toc-section-number">2.1</span> Pypykatz output</a></li>
</ul></li>
<li><a href="#generating-decrypted-session-key"><span class="toc-section-number">3</span> Generating decrypted session key</a></li>
<li><a href="#decrypting-traffic"><span class="toc-section-number">4</span> Decrypting traffic</a>
<ul>
<li><a href="#exporting-smb-objects"><span class="toc-section-number">4.1</span> Exporting SMB objects</a></li>
</ul></li>
<li><a href="#summary"><span class="toc-section-number">5</span> Summary</a></li>
</ul>
</nav>
<main>
<div class="card summary">
<h4>
Summary
</h4>
<hr>
<b><i class="fa-solid fa-box"></i> Source:</b> <a href='https://tryhackme.com/r/room/blockroom'>TryHackMe <i class="fa-solid fa-arrow-up-right-from-square"></i></a><br> <b><i class="fa-solid fa-signal"></i> Difficulty:</b> <span class="medium-diff">Medium</span><br> </span>
</div>
<div class="card">
<h4>
Description
</h4>
<hr>
<p>One of your junior system administrators forgot to deactivate two accounts from a pair of recently fired employees. We believe these employees used the credentials they were given in order to access some of the many private files from our server, but we need concrete proof. The junior system administrator only has a small network capture of the incident and a memory dump of the Local Security Authority Subsystem Service process. Fortunately, for your company, that is all you need.</p>
</span>
</div>
<p>Upon extracting the archive we can see 2 files: <strong>lsass.DMP</strong> and <strong>traffic.pcapng</strong>;</p>
<p><strong>DMP</strong> file is a memory dump, that is data from RAM that is written to a storage drive. Specificly lsass.dmp is memory of <a href="https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service" target="_blank"><strong>LSASS process</strong></a>, which means we might be able to find credentials in there.</p>
<p><strong>PCAPNG</strong> file contains captured network packets, which can be viewed in <strong>Wireshark</strong> (or other software like <strong>tcpdump</strong> or <strong>tshark</strong>).</p>
<h1 data-number="1" id="investigating-the-pcap-file"><span class="header-section-number">1</span> Investigating the PCAP file</h1>
<p>Let’s first take a look at <strong>traffic.pcapng</strong>. <img src="images/image.png" alt="First look at the PCAP file" /></p>
<p>As we can see there is some <strong>SMB2 traffic</strong>. Let’s look at the <strong>info column</strong>.</p>
<p><img src="images/image-2.png" alt="Info section" /> We can see that user <em>mrealman</em> connected to <strong>SMB server</strong> and among others accessed <em>\10.0.2.70\clients</em> file. We will further see encrypted SMB3 packets, which means unfortunately we can’t extract the files user has accessed.</p>
<div class="card">
<h4>
Q1. What is the username of the first person who accessed our server?
</h4>
<hr>
<strong>Answer:</strong> mrealman </span>
</div>
<div class="card">
<h4>
Q4. What is the username of the second person who accessed our server?
</h4>
<hr>
<strong>Answer:</strong> eshellstrop </span>
</div>
<p><img src="images/image-8.png" alt="eshellstrop" /> Further into the capture we can see another user trying to connect to the server - <strong>eshellstrop</strong>.</p>
<p>In order to decrypt the traffic, we need decrypted session key, which we will generate using a Python script below: (you can also find it <a href="https://github.com/jozwikaleksander/smb-sessionkey-gen" target="_blank">here</a>).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="co">+----------------------------------------------------------+</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="co">| ----------- Random SMB2 Session Key Generator ---------- |</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="co">|                                                          |</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="co">|  Author:          Aleksander Jóźwik (@jozwikaleksander)  |</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="co">|  Creation date:   10-08-2024                             |</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="co">|                                                          |                     </span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="co">+----------------------------------------------------------+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="im">import</span> hashlib</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="im">import</span> hmac</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="im">import</span> argparse</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="im">import</span> logging</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="im">from</span> binascii <span class="im">import</span> unhexlify, hexlify</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="im">from</span> Cryptodome.Cipher <span class="im">import</span> ARC4</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="co"># Configure logging</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a>logging.basicConfig(level<span class="op">=</span>logging.INFO, <span class="bu">format</span><span class="op">=</span><span class="st">&#39;</span><span class="sc">%(levelname)s</span><span class="st">: </span><span class="sc">%(message)s</span><span class="st">&#39;</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a><span class="kw">def</span> generate_ntlm_hash(password<span class="op">=</span><span class="va">None</span>, nt_hash<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="co">    Generate NTLM hash from the provided password or return the existing NT hash.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a><span class="co">    :param password: User&#39;s password (string)</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a><span class="co">    :param nt_hash: NT hash (string in hex)</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="co">    :return: NTLM hash in bytes</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a>    <span class="cf">if</span> nt_hash:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a>        <span class="cf">return</span> unhexlify(nt_hash)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a>    <span class="cf">if</span> password:</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a>        <span class="cf">return</span> hashlib.new(<span class="st">&#39;md4&#39;</span>, password.encode(<span class="st">&#39;utf-16le&#39;</span>)).digest()</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;You need to provide either a password or an NT hash.&quot;</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a><span class="kw">def</span> calculate_response_nt_key(ntlmHash, user, domain):</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true"></a><span class="co">    Calculate the ResponseNTKey using the NTLM hash, user, and domain.</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true"></a><span class="co">    :param ntlmHash: NTLM hash in bytes</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true"></a><span class="co">    :param user: Upper-cased user name in bytes (UTF-16LE encoded)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true"></a><span class="co">    :param domain: Upper-cased domain name in bytes (UTF-16LE encoded)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true"></a><span class="co">    :return: ResponseNTKey in bytes</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true"></a>    hmac_md5 <span class="op">=</span> hmac.new(ntlmHash, digestmod<span class="op">=</span>hashlib.md5)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true"></a>    hmac_md5.update(user <span class="op">+</span> domain)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true"></a>    <span class="cf">return</span> hmac_md5.digest()</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true"></a><span class="kw">def</span> calculate_key_exchange_key(responseNtKey, ntProofStr):</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true"></a><span class="co">    Calculate the KeyExchangeKey using the ResponseNTKey and NTProofStr.</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true"></a><span class="co">    :param responseNtKey: ResponseNTKey in bytes</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true"></a><span class="co">    :param ntProofStr: NTProofStr in bytes (hex decoded)</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true"></a><span class="co">    :return: KeyExchangeKey in bytes</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true"></a>    hmac_md5 <span class="op">=</span> hmac.new(responseNtKey, digestmod<span class="op">=</span>hashlib.md5)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true"></a>    hmac_md5.update(ntProofStr)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true"></a>    <span class="cf">return</span> hmac_md5.digest()</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true"></a><span class="kw">def</span> decrypt_session_key(keyExchangeKey, encrypted_key):</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true"></a><span class="co">    Decrypt the session key using RC4 and the KeyExchangeKey.</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true"></a><span class="co">    :param keyExchangeKey: KeyExchangeKey in bytes</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true"></a><span class="co">    :param encrypted_key: Encrypted session key in bytes (hex decoded)</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true"></a><span class="co">    :return: Decrypted session key in bytes</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true"></a>    rc4 <span class="op">=</span> ARC4.new(keyExchangeKey)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true"></a>    <span class="cf">return</span> rc4.encrypt(encrypted_key)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true"></a><span class="kw">def</span> parse_arguments():</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true"></a><span class="co">    Parse command-line arguments.</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true"></a><span class="co">    </span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true"></a><span class="co">    :return: Parsed arguments</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true"></a>    parser <span class="op">=</span> argparse.ArgumentParser(prog<span class="op">=</span><span class="st">&#39;SMB Session Key Generator&#39;</span>, description<span class="op">=</span><span class="st">&#39;Generates random decrypted SMB2 session key&#39;</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true"></a>    </span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true"></a>    <span class="co"># Required Arguments</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-u&#39;</span>, <span class="st">&#39;--user&#39;</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;User name&quot;</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-d&#39;</span>, <span class="st">&#39;--domain&#39;</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Domain name&quot;</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-n&#39;</span>, <span class="st">&#39;--ntproofstr&#39;</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;NTProofStr (hex encoded)&quot;</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-k&#39;</span>, <span class="st">&#39;--key&#39;</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Encrypted Session Key (hex encoded)&quot;</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true"></a>    </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true"></a>    <span class="co"># Optional Arguments</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-p&#39;</span>, <span class="st">&#39;--password&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;User&#39;s password&quot;</span>)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;--ntHash&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;NT hash in hex&quot;</span>)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true"></a>    parser.add_argument(<span class="st">&#39;-v&#39;</span>, <span class="st">&#39;--verbose&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Increase output verbosity&quot;</span>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true"></a>    </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true"></a><span class="kw">def</span> main():</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true"></a>    args <span class="op">=</span> parse_arguments()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true"></a>    <span class="co"># Transforming user and domain to uppercase and converting to bytes</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true"></a>    user <span class="op">=</span> args.user.upper().encode(<span class="st">&#39;utf-16le&#39;</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true"></a>    domain <span class="op">=</span> args.domain.upper().encode(<span class="st">&#39;utf-16le&#39;</span>)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true"></a>        <span class="co"># Generating an NTLM hash and converting it to bytes</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true"></a>        ntlmHash <span class="op">=</span> generate_ntlm_hash(password<span class="op">=</span>args.password, nt_hash<span class="op">=</span>args.ntHash)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true"></a>        <span class="co"># Generating ResponseNTKey</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true"></a>        responseNtKey <span class="op">=</span> calculate_response_nt_key(ntlmHash, user, domain)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true"></a>        <span class="co"># Converting NTPROOFSTR to bytes</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true"></a>        ntProofStr <span class="op">=</span> unhexlify(args.ntproofstr)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true"></a>        <span class="co"># Calculating KeyExchangeKey using NTPROOFSTR and ResponseNTKey</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true"></a>        keyExchangeKey <span class="op">=</span> calculate_key_exchange_key(responseNtKey, ntProofStr)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true"></a>        <span class="co"># Generating decrypted session key</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true"></a>        sessionKey <span class="op">=</span> decrypt_session_key(keyExchangeKey, unhexlify(args.key))</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true"></a>        logging.error(<span class="ss">f&quot;An error occurred: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true"></a>        <span class="cf">return</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true"></a></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true"></a>    <span class="co"># Output results</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true"></a>    <span class="cf">if</span> args.verbose:</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true"></a>        logging.info(<span class="ss">f&quot;Username: </span><span class="sc">{</span>args<span class="sc">.</span>user<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true"></a>        logging.info(<span class="ss">f&quot;Domain: </span><span class="sc">{</span>args<span class="sc">.</span>domain<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true"></a>        <span class="cf">if</span> args.password:</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true"></a>            logging.info(<span class="ss">f&quot;Password: </span><span class="sc">{</span>args<span class="sc">.</span>password<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true"></a>        <span class="cf">if</span> args.ntHash:</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true"></a>            logging.info(<span class="ss">f&quot;NT hash: </span><span class="sc">{</span>args<span class="sc">.</span>ntHash<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true"></a>        logging.info(<span class="ss">f&quot;Ntproofstr: </span><span class="sc">{</span>args<span class="sc">.</span>ntproofstr<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true"></a>        logging.info(<span class="ss">f&quot;Session key: </span><span class="sc">{</span>args<span class="sc">.</span>key<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true"></a>        logging.info(<span class="ss">f&quot;Random generated session key: </span><span class="sc">{</span>hexlify(sessionKey)<span class="sc">.</span>decode()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true"></a>        <span class="bu">print</span>(hexlify(sessionKey).decode())</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true"></a></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true"></a>    main()</span></code></pre></div>
<p><strong>For quick installation:</strong></p>
<pre><code>git clone https://github.com/jozwikaleksander/smb-sessionkey-gen.git
cd smb-sessionkey-gen
pip3 install -r requirements.txt</code></pre>
<p><strong>To use this script we will need following information:</strong></p>
<ul>
<li>Username</li>
<li>Domain</li>
<li>Password (or NT hash)</li>
<li>Ntproofstr</li>
<li>Encrypted session key</li>
</ul>
<h2 data-number="1.1" id="what-is-ntproofstr"><span class="header-section-number">1.1</span> What is Ntproofstr?</h2>
<p>Out of the list above one parameter stands out - <strong>Ntproofstr</strong>. One of the protocols used to authenticate in <strong>SMB</strong> is <a href="https://en.wikipedia.org/wiki/NTLM" target="_blank">NTLM</a> (NT LAN Manager). It’s a <a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication" target="_blank">challenge-response protocol</a>, which means server responds to client’s initial request with <strong>CHALLENGE_MESSAGE</strong> (used to establish the identity of the client), to which client responds with an <strong>AUTHENTICATE_MESSAGE</strong>.</p>
<p>Part of the <strong>AUTHENTICATE_MESSAGE</strong> in <strong>NTLMv2</strong> is <strong>NtProofStr</strong>, which is generated by hashing the <strong>NT hash</strong> (hash of the password), <strong>server challenge</strong> and additional data (such as timestamp and random numbers).</p>
<h2 data-number="1.2" id="how-to-find-ntproofstr"><span class="header-section-number">1.2</span> How to find Ntproofstr?</h2>
<p>Let’s go back to our PCAP file in Wireshark. We will have to do some digging to find the string we are interested in. First select the <strong>Session Setup Request</strong> packet.</p>
<figure>
<img src="images/image-3.png" alt="" /><figcaption>Session Setup Request</figcaption>
</figure>
<p>Next go to <strong>SMB2 &gt; Session Setup Request &gt; Security Blob &gt; GSS-API &gt; Simple Protected Negotiation &gt; negTokenTarg &gt; NTLM Secure Service Provider &gt; NTLM Response &gt; NTLMv2 Response &gt; NTProofStr</strong>, then click the right mouse button on it, choose <em>Copy &gt; … as a Hex Stream</em>.</p>
<figure>
<img src="images/image-4.png" alt="" /><figcaption>NTProofStr</figcaption>
</figure>
<p>In our case <strong>NTProofStr</strong> for <strong>mrealman</strong> is <em>16e816dead16d4ca7d5d6dee4a015c14</em>. For the <strong>eshellstrop</strong> it’s <em>0ca6227a4f00b9654a48908c4801a0ac</em>.</p>
<h2 data-number="1.3" id="finding-encrypted-session-key"><span class="header-section-number">1.3</span> Finding encrypted session key</h2>
<p>As we are already digging in our PCAP file, let’s find session key. It should be already visible when we navigated to NTProofStr. Nonetheless here is the full path: <strong>SMB2 &gt; Session Setup Request &gt; Security Blob &gt; GSS-API &gt; Simple Protected Negotiation &gt; negTokenTarg &gt; NTLM Secure Service Provider &gt; Session Key</strong>.</p>
<figure>
<img src="images/image-5.png" alt="" /><figcaption>Encrypted Session Key</figcaption>
</figure>
<p><strong>Encrypted Session Key</strong> for <em>mrealman</em>: <em>fde53b54cb676b9bbf0fb1fbef384698</em>; <strong>Encrypted Session Key</strong> for <em>eshellstrop</em>: <em>c24f5102a22d286336aac2dfa4dc2e04</em>;</p>
<p>You might wonder why are why trying to generate session key if we can find one in the PCAP file, the difference is this one is encrypted, we need one that is decrypted 😅.</p>
<h2 data-number="1.4" id="finding-the-session-id"><span class="header-section-number">1.4</span> Finding the session id</h2>
<p>That one is easier, go to <strong>SMB2 &gt; SMB2 Header &gt; Session Id</strong>, click on it with right mouse button and press <strong>Copy &gt; … as a Hex Stream</strong>.</p>
<figure>
<img src="images/image-7.png" alt="" /><figcaption>Session ID</figcaption>
</figure>
<p><strong>Session ID</strong> for <em>mrealman</em>: 4100000000100000 <br> <strong>Session ID</strong> for <em>eshellstrop</em>: 4500000000100000</p>
<h2 data-number="1.5" id="script-explanation"><span class="header-section-number">1.5</span> Script Explanation</h2>
<p>I will explain the Python script step by step, if you are not interested <a href="#reading-the-dmp-file">skip this part</a>.</p>
<h3 data-number="1.5.1" id="transforming-username-and-domain-to-uppercase-next-converting-it-to-bytes."><span class="header-section-number">1.5.1</span> Transforming username and domain to uppercase, next converting it to bytes.</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>user <span class="op">=</span> args.user.upper().encode(<span class="st">&#39;utf-16le&#39;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>domain <span class="op">=</span> args.domain.upper().encode(<span class="st">&#39;utf-16le&#39;</span>)</span></code></pre></div>
<h3 data-number="1.5.2" id="generating-ntlm-hash-using-md4-hash-function-if-needed"><span class="header-section-number">1.5.2</span> Generating NTLM hash using MD4 hash function if needed</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">def</span> generate_ntlm_hash(password<span class="op">=</span><span class="va">None</span>, nt_hash<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">    Generate NTLM hash from the provided password or return the existing NT hash.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">    :param password: User&#39;s password (string)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co">    :param nt_hash: NT hash (string in hex)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co">    :return: NTLM hash in bytes</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    <span class="cf">if</span> nt_hash:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>        <span class="cf">return</span> unhexlify(nt_hash)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="cf">if</span> password:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>        <span class="cf">return</span> hashlib.new(<span class="st">&#39;md4&#39;</span>, password.encode(<span class="st">&#39;utf-16le&#39;</span>)).digest()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;You need to provide either a password or an NT hash.&quot;</span>)</span></code></pre></div>
<h3 data-number="1.5.3" id="next-we-are-calculating-response-nt-key"><span class="header-section-number">1.5.3</span> Next we are calculating Response NT Key</h3>
<p><strong>ResponseNTKey</strong> is an intermediate value, generated using NTLM hash and concatenation of username and domainname. It’s done using <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.hmacmd5?view=net-8.0">HMAC-MD5</a>, where the NTLMv2 hash serves as the key and the concatenated username and domain are the data being hashed., where the NTLMv2 hash serves as the key and the concatenated username and domain are the data being hashed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">def</span> calculate_response_nt_key(ntlmHash, user, domain):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="co">    Calculate the ResponseNTKey using the NTLM hash, user, and domain.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="co">    :param ntlmHash: NTLM hash in bytes</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span class="co">    :param user: Upper-cased user name in bytes (UTF-16LE encoded)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co">    :param domain: Upper-cased domain name in bytes (UTF-16LE encoded)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="co">    :return: ResponseNTKey in bytes</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>    hmac_md5 <span class="op">=</span> hmac.new(ntlmHash, digestmod<span class="op">=</span>hashlib.md5)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    hmac_md5.update(user <span class="op">+</span> domain)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>    <span class="cf">return</span> hmac_md5.digest()</span></code></pre></div>
<h3 data-number="1.5.4" id="generating-keyexchangekey"><span class="header-section-number">1.5.4</span> Generating KeyExchangeKey</h3>
<p><strong>KeyExchangeKey</strong> is used to encrypt or decrypt the session key that will be used to secure communication. It is calculated by combining <a href="#next-we-are-calculating-response-nt-key">ResponseNTKey</a> and <a href="#what-is-ntproofstr">NTProofStr</a>. Again it’s created using <a href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.hmacmd5?view=net-8.0">HMAC-MD5</a> hash.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">def</span> calculate_key_exchange_key(responseNtKey, ntProofStr):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co">    Calculate the KeyExchangeKey using the ResponseNTKey and NTProofStr.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">    :param responseNtKey: ResponseNTKey in bytes</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="co">    :param ntProofStr: NTProofStr in bytes (hex decoded)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="co">    :return: KeyExchangeKey in bytes</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    hmac_md5 <span class="op">=</span> hmac.new(responseNtKey, digestmod<span class="op">=</span>hashlib.md5)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>    hmac_md5.update(ntProofStr)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>    <span class="cf">return</span> hmac_md5.digest()</span></code></pre></div>
<h3 data-number="1.5.5" id="decrypting-session-key"><span class="header-section-number">1.5.5</span> Decrypting session key</h3>
<p>With the help of the key we created in last step, we can decrypt the session key using <a href="https://pl.wikipedia.org/wiki/RC4">RC4</a>. <a href="https://pl.wikipedia.org/wiki/RC4">RC4</a> is a stream cipher, so it’s using the same operation (<a href="https://pl.wikipedia.org/wiki/RC4">XOR</a>) for encrypting and decrypting, that’s why we are using <strong>rc4.encrypt</strong> function in the code below.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">def</span> decrypt_session_key(keyExchangeKey, encrypted_key):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">    Decrypt the session key using RC4 and the KeyExchangeKey.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="co">    :param keyExchangeKey: KeyExchangeKey in bytes</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">    :param encrypted_key: Encrypted session key in bytes (hex decoded)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a><span class="co">    :return: Decrypted session key in bytes</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    rc4 <span class="op">=</span> ARC4.new(keyExchangeKey)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>    <span class="cf">return</span> rc4.encrypt(encrypted_key)</span></code></pre></div>
<h1 data-number="2" id="reading-the-dmp-file"><span class="header-section-number">2</span> Reading the DMP file</h1>
<p>Next we will need a <strong>user’s password</strong>. For that we will look at the <strong>lsass.DMP file</strong>. In order to read it we will use <strong>pypykatz tool</strong>, which is installed on Kali Linux by default. We will use the following command:</p>
<pre><code>pypykatz lsa minidump lsass.DMP</code></pre>
<h2 data-number="2.1" id="pypykatz-output"><span class="header-section-number">2.1</span> Pypykatz output</h2>
<p>I will only show important parts of the output as it’s pretty long.</p>
<pre><code>[...]

username mrealman
domainname BLOCK
logon_server WIN-2258HHCBNQR
logon_time 2023-10-22T16:53:54.168637+00:00
sid S-1-5-21-3761843758-2185005375-3584081457-1104
luid 1883004
        == MSV ==
                Username: mrealman
                Domain: BLOCK
                LM: NA
                NT: 1f9175a516211660c7a8143b0f36ab44
                SHA1: ccd27b4bf489ffda2251897ef86fdb488f248aef
                DPAPI: 3d618a1fffd6c879cd0b056910ec0c31

[...]

username eshellstrop
domainname BLOCK
logon_server WIN-2258HHCBNQR
logon_time 2023-10-22T16:46:09.215626+00:00
sid S-1-5-21-3761843758-2185005375-3584081457-1103
luid 828825
        == MSV ==
                Username: eshellstrop
                Domain: BLOCK
                LM: NA
                NT: 3f29138a04aadc19214e9c04028bf381
                SHA1: 91374e6e58d7b523376e3b1eb04ae5440e678717
                DPAPI: 87c8e56bc4714d4c5659f254771559a8

[...]</code></pre>
<p>As we can see there are <strong>NT hashes</strong> for our user (<em>mrealman</em>) and other user - <em>eshellstrop</em> (to which we will come later). We won’t need passwords in plaintext for the script itself, but we need the first user’s password to answer a question. To crack the hash we will use an online tool called <a href="https://crackstation.net/" target="_blank">CrackStation</a>.</p>
<p>Navigate to the site, paste the hash and press <strong>Crack Hashes</strong>.</p>
<figure>
<img src="images/image-6.png" alt="" /><figcaption>Cracking hash</figcaption>
</figure>
<div class="card">
<h4>
Q5. What is the hash of the user in question 4?
</h4>
<hr>
<strong>Answer:</strong> 3f29138a04aadc19214e9c04028bf381 </span>
</div>
<h1 data-number="3" id="generating-decrypted-session-key"><span class="header-section-number">3</span> Generating decrypted session key</h1>
<p>We’ve gathered all data we need to run the script. To sum up here is the data for the first user - <strong>mrealman</strong> and the second user (as the process is exactly the same I won’t show it) <strong>eshellstrop</strong>.</p>
<div class="card">
<h4>
First user’s parameters
</h4>
<hr>
<ul>
<li><strong>Username:</strong> mrealman</li>
<li><strong>Domain</strong> (found in a PCAP file, not the one in DMP): WORKGROUP</li>
<li><strong>NTProofStr:</strong> 16e816dead16d4ca7d5d6dee4a015c14</li>
<li><strong>Encrypted Session key:</strong> fde53b54cb676b9bbf0fb1fbef384698</li>
<li><strong>NT Hash:</strong> 1f9175a516211660c7a8143b0f36ab44</li>
</ul>
</span>
</div>
<p><strong>Command:</strong></p>
<pre><code>python3 smb-key-gen.py -u mrealman -d workgroup --ntHash 1f9175a516211660c7a8143b0f36ab44 -n 16e816dead16d4ca7d5d6dee4a015c14 -k fde53b54cb676b9bbf0fb1fbef384698</code></pre>
<p><strong>Output:</strong></p>
<pre><code>20a642c086ef74eee26277bf1d0cff8c</code></pre>
<div class="card">
<h4>
Second user’s parameters
</h4>
<hr>
<ul>
<li><strong>Username:</strong> eshellstrop</li>
<li><strong>Domain</strong> (found in a PCAP file, not the one in DMP): WORKGROUP</li>
<li><strong>NT Hash:</strong> 3f29138a04aadc19214e9c04028bf381</li>
<li><strong>NTProofStr:</strong> 0ca6227a4f00b9654a48908c4801a0ac</li>
<li><strong>Encrypted Session key:</strong> c24f5102a22d286336aac2dfa4dc2e04</li>
</ul>
</span>
</div>
<p><strong>Command:</strong></p>
<pre><code>python3 smb-key-gen.py -u eshellstrop -d WORKGROUP --ntHash 3f29138a04aadc19214e9c04028bf381 -n 0ca6227a4f00b9654a48908c4801a0ac -k c24f5102a22d286336aac2dfa4dc2e04</code></pre>
<p><strong>Output:</strong></p>
<pre><code>facfbdf010d00aa2574c7c41201099e8</code></pre>
<h1 data-number="4" id="decrypting-traffic"><span class="header-section-number">4</span> Decrypting traffic</h1>
<figure>
<img src="images/image-9.png" alt="" /><figcaption>SMB Protocol Preferences</figcaption>
</figure>
<p>In order to decrypt the traffic, select any SMB2 packet choose <strong>Protocol Preferences &gt; SMB2 &gt; Secret session keys for decryption</strong>.</p>
<figure>
<img src="images/image-10.png" alt="" /><figcaption>Secret session keys</figcaption>
</figure>
<p>Fill in data we gathered earlier, and press OK.</p>
<h2 data-number="4.1" id="exporting-smb-objects"><span class="header-section-number">4.1</span> Exporting SMB objects</h2>
<p>To export files from the PCAP file, go to <strong>File &gt; Export Objects &gt; SMB…</strong>;</p>
<figure>
<img src="images/image-11.png" alt="" /><figcaption>Exporting objects</figcaption>
</figure>
<figure>
<img src="images/image-12.png" alt="" /><figcaption>SMB Object List</figcaption>
</figure>
<p>As you can see we’ve got two file ready to be exported, select <strong>Save all</strong> and choose the path.</p>
<p>Navigate to chosen directory and read the files.</p>
<figure>
<img src="images/image-13.png" alt="" /><figcaption>Flags</figcaption>
</figure>
</main>
<h1 data-number="5" id="summary"><span class="header-section-number">5</span> Summary</h1>
<p>This was a really cool box! It helped me get a better grasp on how SMB and NTLM work, and I had a lot of fun figuring out the solution. I’m excited to find more boxes like this in the future.</p>
<div class="footer">
    <p>Made by Aleksander Jóźwik</p>
</div>
</body>
</html>
